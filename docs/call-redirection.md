# Call Redirection in LLM Agents

This document describes how to handle call redirection in LLM agents using both the fallback option and the builtin transfer function.

## Fallback Option

The fallback option provides an automatic redirection mechanism when the LLM is unavailable or not responding. This is configured at agent creation time in the `options.fallback` property.

### Configuration

```json
{
  "options": {
    "fallback": {
      "number": ["+44123456789", "+44123456780"]
    }
  }
}
```

The fallback number(s) will be used in the following scenarios:
- LLM service is unavailable
- LLM is not responding within expected timeouts
- Critical errors in the LLM pipeline

The fallback number is also available as metadata in function calls via `aplisay.fallbackNumber`.

## Builtin Transfer Function

For more dynamic control, you can use the builtin `transfer` platform function to redirect calls programmatically based on LLM decisions.

### Function Definition

```json
{
  "functions": [
    {
      "name": "transfer_call",
      "description": "Transfer the call to a human agent or another service",
      "implementation": "builtin",
      "platform": "transfer",
      "input_schema": {
        "properties": {
          "number": {
            "type": "string",
            "description": "The phone number to transfer the call to",
            "source": "metadata",
            "from": "aplisay.fallbackNumber"
          }
        }
      }
    }
  ]
}
```

### Usage Notes

1. The transfer function is only available to telephone agents
2. The `number` parameter can only be specified as:
   - `static`: A hardcoded number
   - `metadata`: Using values like `aplisay.fallbackNumber`
3. For security reasons, the number cannot be generated by the LLM (no `generated` source type allowed)

### Example Scenarios

1. **Automatic Fallback**
   ```json
   {
     "options": {
       "fallback": {
         "number": ["+44123456789"]
       }
     }
   }
   ```
   The call will automatically transfer to +44123456789 if the LLM fails.

2. **Programmatic Transfer**
   ```json
   {
     "functions": [
       {
         "name": "transfer_to_human",
         "description": "Transfer the call to a human agent when the conversation requires human intervention",
         "implementation": "builtin",
         "platform": "transfer",
         "input_schema": {
           "properties": {
             "number": {
               "type": "string",
               "source": "metadata",
               "from": "aplisay.fallbackNumber"
             }
           }
         }
       }
     ]
   }
   ```
   The LLM can use this function to transfer calls when it determines human intervention is needed.

3. **Multiple Fallback Numbers**
   ```json
   {
     "options": {
       "fallback": {
         "number": ["+44123456789", "+44123456780", "+44123456771"]
       }
     }
   }
   ```
   The system will try each number in sequence if the LLM fails.

## Best Practices

1. Always provide at least one fallback number for telephone agents
2. Use the builtin transfer function for business logic-based transfers
3. Keep fallback numbers up to date and monitored
4. Consider time-of-day and availability when setting up fallback numbers
5. Document the fallback and transfer logic in your agent's prompt

## Security Considerations

1. Never allow the LLM to generate transfer numbers
2. Validate all transfer numbers against allowed patterns
3. Monitor transfer patterns for potential abuse
4. Keep fallback numbers in a secure configuration
5. Log all transfers for audit purposes 