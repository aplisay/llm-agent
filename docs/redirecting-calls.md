# Call Redirection in LLM Agents

This document describes how to handle call redirection in LLM agents using both the fallback option and the builtin transfer function.

This functionality is only available for telephone agents, and only when outbound calling or SIP redirects are enabled for the provider trunk. This is not enabled on the free tier of our hosted platform.

## Fallback Option

The fallback option provides an automatic redirection mechanism when the LLM is unavailable or not responding. This is configured at agent creation time in the `options.fallback` property.

### Configuration

```json
{
  "options": {
    "fallback": {
      "number": "+44123456789"
    }
  }
}
```

The fallback number will be used in the following scenarios if configured and available on the trunk:
- LLM service is unavailable
- Critical errors in the LLM pipeline

The configured fallback number is also available as metadata in function calls via `aplisay.fallbackNumber`.

## Builtin Transfer Function

For more dynamic control, you can use the builtin `transfer` platform function to redirect calls based on LLM decisions. Again, this is only available for telephone agents, and only when outbound calling or SIP redirects are enabled for the provider trunk.

### Function Definition

```json
{
  "functions": [
    {
      "name": "transfer_call",
      "description": "Transfer the call to a human agent or another service",
      "implementation": "builtin",
      "platform": "transfer",
      "input_schema": {
        "properties": {
          "number": {
            "type": "string",
            "description": "The phone number to transfer the call to",
            "source": "metadata",
            "from": "aplisay.fallbackNumber"
          }
        }
      }
    }
  ]
}
```

### Usage Notes

1. The transfer function is only available to telephone agents
2. The `number` parameter can only be specified as:
   - `static`: A hardcoded number
   - `metadata`: Using values like `aplisay.fallbackNumber`
3. For abuse prevention reasons, the number cannot be generated by the LLM (no `generated` source type allowed)

### Example Scenarios

1. **Automatic Fallback**
   ```json
   {
     "options": {
       "fallback": {
         "number": "+44123456789"
       }
     }
   }
   ```
   The call will automatically transfer to +44123456789 if the LLM fails.

2. **Programmatic Transfer**
   ```json
   {
     "functions": [
       {
         "name": "transfer_to_human",
         "description": "Transfer the call to a human agent when the conversation requires human intervention",
         "implementation": "builtin",
         "platform": "transfer",
         "input_schema": {
           "properties": {
             "number": {
               "type": "string",
               "source": "metadata",
               "from": "aplisay.fallbackNumber"
             }
           }
         }
       }
     ]
   }
   ```
   The LLM can use this function to transfer calls when it determines human intervention is needed.

3. **Multiple Transfer Functions**
   ```json
   {
     "functions": [
       {
         "name": "transfer_main",
         "description": "Transfer the call to the main customer service line",
         "implementation": "builtin",
         "platform": "transfer",
         "input_schema": {
           "properties": {
             "number": {
               "type": "string",
               "description": "The main customer service number",
               "source": "static",
               "from": "+44123456789"
             }
           }
         }
       },
       {
         "name": "transfer_returns",
         "description": "Transfer the call to the returns department",
         "implementation": "builtin",
         "platform": "transfer",
         "input_schema": {
           "properties": {
             "number": {
               "type": "string",
               "description": "The returns department number",
               "source": "static",
               "from": "+44123456780"
             }
           }
         }
       }
     ]
   }
   ```
   
   This example shows how to set up multiple transfer functions, each with its own static number. The LLM can choose which department to transfer to based on the caller's needs.

   A similar effect could be achieved in a more data driven way by using custom metadata on the listen call to determine which number to transfer to.

## Best Practices

1. Always provide a fallback number for telephone agents
2. Use the builtin transfer function for business logic-based transfers
3. Keep fallback numbers up to date and monitored
4. Consider time-of-day and availability when designing use cases for transfer numbers
5. Document the fallback and transfer logic in your agent's prompt and test

## Security Considerations

1. Never allow the LLM to generate transfer numbers, pull them programatically from metadata or static values in function calls only
2. Validate all transfer numbers in self service setup against allowed patterns (*eg* UK mobile or geographic numbers) to prevent fraud via *eg* triggering transfers to premium rate numbers
3. Monitor transfer patterns for potential abuse
4. Keep fallback numbers in a secure configuration

