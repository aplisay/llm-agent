# Call Redirection in LLM Agents

This document describes how to handle call redirection in LLM agents using both the fallback option and the builtin transfer function.

This functionality is only available for telephone agents, and only when outbound calling or SIP redirects are enabled for the provider trunk. This is not enabled on the free tier of our hosted platform.

## Fallback Option

The fallback option provides an automatic redirection mechanism when the LLM is unavailable or not responding. This is configured at agent creation time in the `options.fallback` property.

### Configuration

```json
{
  "options": {
    "fallback": {
      "number": "+44123456789"
    }
  }
}
```

The fallback number will be used in the following scenarios if configured and available on the trunk:
- LLM service is unavailable
- Critical errors in the LLM pipeline

The configured fallback number is also available as metadata in function calls via `aplisay.fallbackNumber`.

## Builtin Transfer Functions

For more dynamic control, you can use the builtin `transfer` platform function to redirect calls based on LLM decisions. Again, this is only available for telephone agents, and only when outbound calling or SIP redirects are enabled for the provider trunk.

Additionally, a builtin `transfer_status` function is always available to check the current status of any in-progress transfer.

### Function Definition

```json
{
  "functions": [
    {
      "name": "transfer_call",
      "description": "Transfer the call to a human agent or another service",
      "implementation": "builtin",
      "platform": "transfer",
      "input_schema": {
        "properties": {
          "number": {
            "type": "string",
            "description": "The phone number to transfer the call to",
            "source": "metadata",
            "from": "aplisay.fallbackNumber"
          }
        }
      }
    }
  ]
}
```

### Transfer Types

The `transfer` function supports two types of transfers:

1. **Blind Transfer** (`operation: "blind"` or omitted): Immediately transfers the call to the specified number. The function returns `OK` when the transfer completes, or `FAILED` with a reason if it fails.

2. **Consultative Transfer** (`operation: "consultative"`): For "warm" transfers where the agent first speaks with the transfer target before connecting them to the caller. The function returns immediately after the consultation call is placed, with status `OK` and a message indicating the consultation has started. The transfer continues in the background, and you can check its progress using the `transfer_status` function.

### Transfer Status Function

The `transfer_status` function is a builtin function that is always available to telephone agents. It takes no parameters and returns the current state of any in-progress transfer:

- **State values:**
  - `none`: No transfer in progress
  - `dialling`: The transfer target is being called
  - `talking`: The agent is speaking with the transfer target (consultative transfers only)
  - `rejected`: The transfer target declined the transfer (consultative transfers only)
  - `failed`: The transfer failed

- **Response format:**
  ```json
  {
    "state": "talking",
    "description": "Speaking with transfer target..."
  }
  ```

For consultative transfers, you should periodically call `transfer_status` to check the progress. When the state becomes `none`, `rejected`, or `failed`, the transfer has completed (or been cancelled).

### Usage Notes

1. The transfer function is only available to telephone agents
2. The `number` parameter can only be specified as:
   - `static`: A hardcoded number
   - `metadata`: Using values like `aplisay.fallbackNumber`
3. For abuse prevention reasons, the number cannot be generated by the LLM (no `generated` source type allowed)
4. For consultative transfers, the function returns immediately after starting the consultation. Use `transfer_status` to monitor progress
5. Only one transfer can be in progress at a time. If a transfer is already in progress, subsequent transfer requests will return `FAILED`

### Example Scenarios

1. **Automatic Fallback**
   ```json
   {
     "options": {
       "fallback": {
         "number": "+44123456789"
       }
     }
   }
   ```
   The call will automatically transfer to +44123456789 if the LLM fails.

2. **Programmatic Transfer**
   ```json
   {
     "functions": [
       {
         "name": "transfer_to_human",
         "description": "Transfer the call to a human agent when the conversation requires human intervention",
         "implementation": "builtin",
         "platform": "transfer",
         "input_schema": {
           "properties": {
             "number": {
               "type": "string",
               "source": "metadata",
               "from": "aplisay.fallbackNumber"
             }
           }
         }
       }
     ]
   }
   ```
   The LLM can use this function to transfer calls when it determines human intervention is needed.

3. **Multiple Transfer Functions**
   ```json
   {
     "functions": [
       {
         "name": "transfer_main",
         "description": "Transfer the call to the main customer service line",
         "implementation": "builtin",
         "platform": "transfer",
         "input_schema": {
           "properties": {
             "number": {
               "type": "string",
               "description": "The main customer service number",
               "source": "static",
               "from": "+44123456789"
             }
           }
         }
       },
       {
         "name": "transfer_returns",
         "description": "Transfer the call to the returns department",
         "implementation": "builtin",
         "platform": "transfer",
         "input_schema": {
           "properties": {
             "number": {
               "type": "string",
               "description": "The returns department number",
               "source": "static",
               "from": "+44123456780"
             }
           }
         }
       }
     ]
   }
   ```
   
   This example shows how to set up multiple transfer functions, each with its own static number. The LLM can choose which department to transfer to based on the caller's needs.

   A similar effect could be achieved in a more data driven way by using custom metadata on the listen call to determine which number to transfer to...

4. **Multiple Transfer Functions with Numbers Sourced from External Source of Truth**

   ```json
   {
     "functions": [
       {
         "name": "transfer_customer_service",
         "description": "Transfer the call to the customer service team assigned to this customer",
         "implementation": "builtin",
         "platform": "transfer",
         "input_schema": {
           "properties": {
             "number": {
               "type": "string",
               "description": "The customer service contact number from CRM",
               "source": "metadata",
               "from": "crm.cSContact"
             }
           }
         }
       },
       {
         "name": "transfer_returns_team",
         "description": "Transfer the call to the returns team assigned to this customer",
         "implementation": "builtin",
         "platform": "transfer",
         "input_schema": {
           "properties": {
             "number": {
               "type": "string",
               "description": "The returns team contact number from CRM",
               "source": "metadata",
               "from": "crm.returnsContact"
             }
           }
         }
       }
     ]
   }
   ```

   This example shows how to use transfer functions with contact numbers sourced dynamically from an external CRM system. The numbers are passed as metadata (`crm.cSContact` and `crm.returnsContact`) and could for example be updated in real-time based on customer assignments, team availability, or just time of day in the CRM system without needing to dynamically change the agent spec.
  

   > **Security Note**: When using external systems like CRM to source transfer numbers, there is a potential that malicious users could abuse the system by triggering transfers to premium rate numbers. To prevent this, ensure that:
   > 1. The external system has proper validation of phone numbers before they are stored
   > 2. The numbers are vetted against allowed patterns (e.g., only company-owned numbers, or only UK mobile or geographic numbers)
   > 3. Access to modify these numbers is properly secured
   > 4. Consider implementing extra checks or a whitelist of allowed numbers in your middleware or API which loads the metadata.
   > 5. Monitor transfer patterns for any unexpected changes in destination numbers


## Best Practices

1. Always provide a fallback number for telephone agents
2. Use the builtin transfer function for business logic-based transfers
3. Keep fallback numbers up to date and monitored
4. Consider time-of-day and availability when designing use cases for transfer numbers
5. Document the fallback and transfer logic in your agent's prompt and test

## Security Considerations

1. Never allow the LLM to generate transfer numbers, pull them programatically from metadata or static values in function calls only
2. Validate all transfer numbers in self service setup against allowed patterns (*eg* UK mobile or geographic numbers) to prevent fraud via *eg* triggering transfers to premium rate numbers
3. Monitor transfer patterns for potential abuse
4. Keep fallback numbers in a secure configuration

